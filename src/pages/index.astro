---
import Layout from "../layouts/Layout.astro";
import Terminal from "../components/Terminal.astro";
import { getCollection, render } from "astro:content";

// Fetch all content collections
const aboutEntries = await getCollection("about");
const skillsEntries = await getCollection("skills");
const experienceEntries = await getCollection("experience");
const projectsEntries = await getCollection("projects");
const achievementsEntries = await getCollection("achievements");
const educationEntries = await getCollection("education");
const contactEntries = await getCollection("contact");
const neofetchEntries = await getCollection("neofetch");

// Sort by order
const skills = skillsEntries.sort((a, b) => a.data.order - b.data.order);
const experiences = experienceEntries.sort((a, b) => a.data.order - b.data.order);
const projects = projectsEntries.sort((a, b) => a.data.order - b.data.order);
const achievements = achievementsEntries.sort((a, b) => a.data.order - b.data.order);
const educations = educationEntries.sort((a, b) => a.data.order - b.data.order);

// Get single entries
const about = aboutEntries[0];
const contact = contactEntries[0];
const neofetch = neofetchEntries[0];

// Render MDX content to HTML
async function renderContent(entry: any) {
  const { Content } = await render(entry);
  return Content;
}

// Helper to convert markdown-like bold to HTML
function parseBold(text: string): string {
  return text.replace(/\*\*([^*]+)\*\*/g, '<span class="text-bold">$1</span>');
}

// Build about section HTML
const aboutContent = await renderContent(about);
const aboutHtml = `
<span class="ascii-art"> â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
 â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
 â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
 â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
 â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•</span>
<div class="section-header">ğŸ‘‹ About Me</div>

<p class="text-fg">I'm a <span class="text-green text-bold">${about.data.title.split(" & ")[0]}</span> and <span class="text-cyan text-bold">${about.data.title.split(" & ")[1] || ""}</span> based in <span class="text-yellow">${about.data.location}</span>.</p>

<p class="text-fg" style="margin-top: 10px;">I build <span class="text-magenta">production-grade platforms</span> with deep experience in:</p>

<div style="margin: 15px 0;">
${about.data.highlights.map((h: string) => {
  const parsed = parseBold(h);
  return `<div class="list-item text-fg">${parsed}</div>`;
}).join("\n")}
</div>

<p class="text-comment" style="margin-top: 15px;">
I've worked directly with CTOs and startup founders, led engineering teams, 
and built things that ship, scale, and make money. ğŸ’°
</p>

<div style="margin-top: 20px;">
    <span class="text-magenta text-bold">What Makes Me Different:</span>
    <div style="margin-top: 10px;">
${about.data.differentiators.map((d: string) => `<span class="tag">âœ” ${d}</span>`).join("\n")}
    </div>
</div>
`;

// Build skills section HTML
let skillsHtml = '<div class="section-header">ğŸ› ï¸ Technical Skills</div>';

for (const skill of skills) {
  const colorClass = `text-${skill.data.color}`;
  skillsHtml += `\n<div class="${colorClass} text-bold" style="margin: 15px 0 10px 0;">// ${skill.data.category}</div>`;
  
  if (skill.data.items && skill.data.items.length > 0) {
    // Progress bars for languages
    for (const item of skill.data.items) {
      skillsHtml += `
<div class="progress-bar">
    <span class="progress-label">${item.name}</span>
    <div class="progress-track"><div class="progress-fill" style="width: ${item.level}%"></div></div>
    <span class="progress-value">${item.label || ""}</span>
</div>`;
    }
  } else if (skill.data.tags && skill.data.tags.length > 0) {
    // Tags for other skills
    skillsHtml += `<div style="display: flex; flex-wrap: wrap; gap: 6px;">`;
    for (const tag of skill.data.tags) {
      skillsHtml += `<span class="tag">${tag}</span>`;
    }
    skillsHtml += `</div>`;
  }
}

// Build experience section HTML
let experienceHtml = '<div class="section-header">ğŸ’¼ Professional Experience</div>';

for (const exp of experiences) {
  const { Content } = await render(exp);
  experienceHtml += `
<div class="timeline-item">
    <div class="timeline-title">${exp.data.title} @ ${exp.data.company}</div>
    <div class="timeline-subtitle">${exp.data.companyType || ""} â€¢ ${exp.data.location} â€¢ ${exp.data.period}</div>
    <div class="timeline-content" id="exp-${exp.id}">
    </div>
</div>`;
}

// We need to render experience content differently - let's use a simpler approach
experienceHtml = '<div class="section-header">ğŸ’¼ Professional Experience</div>';

for (const exp of experiences) {
  // Get the raw body and convert to HTML-like format
  const body = exp.body || "";
  const lines = body.split("\n").filter((l: string) => l.trim());
  
  let contentHtml = "";
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed.startsWith("- ")) {
      // List item
      const text = parseBold(trimmed.slice(2));
      contentHtml += `<div class="list-item">${text}</div>`;
    } else if (trimmed && !trimmed.startsWith("---")) {
      // Paragraph
      contentHtml += `<p>${parseBold(trimmed)}</p>`;
    }
  }
  
  const tagsHtml = exp.data.tags?.map((t: string) => `<span class="tag">${t}</span>`).join("\n") || "";
  
  experienceHtml += `
<div class="timeline-item">
    <div class="timeline-title">${exp.data.title} @ ${exp.data.company}</div>
    <div class="timeline-subtitle">${exp.data.companyType || ""} â€¢ ${exp.data.location} â€¢ ${exp.data.period}</div>
    <div class="timeline-content">
        ${contentHtml}
        <div style="margin-top: 10px;">
            ${tagsHtml}
        </div>
    </div>
</div>`;
}

// Build projects section HTML
let projectsHtml = '<div class="section-header">ğŸš€ Featured Projects</div>';

for (const project of projects) {
  const body = project.body || "";
  const lines = body.split("\n").filter((l: string) => l.trim());
  
  let contentHtml = "";
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed.startsWith("- ")) {
      const text = parseBold(trimmed.slice(2));
      contentHtml += `<div class="list-item">${text}</div>`;
    } else if (trimmed && !trimmed.startsWith("---")) {
      contentHtml += `<p>${parseBold(trimmed)}</p>`;
    }
  }
  
  const tagsHtml = project.data.tags.map((t: string) => `<span class="tag">${t}</span>`).join("\n");
  
  projectsHtml += `
<div class="card" style="border-left-color: var(--${project.data.color});">
    <div class="card-title">${project.data.title}</div>
    <div class="card-subtitle">${project.data.subtitle}</div>
    <div class="card-content">
        ${contentHtml}
        <div style="margin-top: 10px;">
            ${tagsHtml}
        </div>
    </div>
</div>`;
}

projectsHtml += `
<p class="text-comment" style="margin-top: 15px;">
    ğŸ“‚ More projects at <a href="https://github.com/PriyanshuSharma23" target="_blank" class="link">github.com/PriyanshuSharma23</a>
</p>`;

// Build achievements section HTML
const awards = achievements.filter(a => a.data.type === "award");
const leadership = achievements.filter(a => a.data.type === "leadership");

let achievementsHtml = '<div class="section-header">ğŸ† Achievements & Recognition</div>';
achievementsHtml += '<div style="margin: 15px 0;">';

for (const award of awards) {
  const body = award.body?.trim() || "";
  const extraText = body ? ` <span class="text-comment">(${body.replace(/\n/g, " ")})</span>` : "";
  achievementsHtml += `<div class="badge text-fg"><span class="badge-icon">${award.data.icon}</span> <span class="text-yellow">${award.data.highlight}</span> â€” ${award.data.title}${extraText}</div>`;
}

achievementsHtml += '</div>';
achievementsHtml += '<div class="section-header" style="margin-top: 25px;">ğŸ–ï¸ Leadership & Community</div>';

for (const lead of leadership) {
  const body = lead.body?.trim() || "";
  const contentText = parseBold(body.replace(/\n/g, " "));
  achievementsHtml += `
<div class="card" style="border-left-color: var(--${lead.data.color || "blue"});">
    <div class="card-title">${lead.data.title}</div>
    <div class="card-content">${contentText}</div>
</div>`;
}

// Build education section HTML
let educationHtml = '<div class="section-header">ğŸ“ Education</div>';

for (const edu of educations) {
  educationHtml += `
<div class="card" style="border-left-color: var(--blue);">
    <div class="card-title">${edu.data.degree}</div>
    <div class="card-subtitle">${edu.data.institution}</div>
    <div class="card-content" style="margin-top: 10px;">
        <div class="table">
            <div class="table-row">
                <span class="table-key">CGPA</span>
                <span class="table-value"><span class="text-green text-bold">${edu.data.cgpa}</span> / 10</span>
            </div>
            ${edu.data.honors ? `<div class="table-row">
                <span class="table-key">Honors</span>
                <span class="table-value"><span class="text-yellow">${edu.data.honors}</span></span>
            </div>` : ""}
            ${edu.data.specialization ? `<div class="table-row">
                <span class="table-key">Specialization</span>
                <span class="table-value">${edu.data.specialization}</span>
            </div>` : ""}
        </div>
    </div>
</div>`;

  if (edu.data.coursework && edu.data.coursework.length > 0) {
    educationHtml += `
<div style="margin-top: 20px;">
    <span class="text-magenta text-bold">Relevant Coursework:</span>
    <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px;">
        ${edu.data.coursework.map((c: string) => `<span class="tag">${c}</span>`).join("\n")}
    </div>
</div>`;
  }
}

// Build contact section HTML
let contactHtml = '<div class="section-header">ğŸ“¬ Let\'s Connect!</div>';
contactHtml += '<p class="text-fg">I\'m open to new opportunities and collaborations:</p>';
contactHtml += `
<div class="table" style="margin: 20px 0;">
    <div class="table-row">
        <span class="table-key">ğŸ“§ Email</span>
        <span class="table-value"><a href="mailto:${contact.data.email}" class="link">${contact.data.email}</a></span>
    </div>
    <div class="table-row">
        <span class="table-key">ğŸ“ Phone</span>
        <span class="table-value"><a href="tel:${contact.data.phone}" class="link">${contact.data.phone}</a></span>
    </div>
    <div class="table-row">
        <span class="table-key">ğŸ™ GitHub</span>
        <span class="table-value"><a href="https://${contact.data.github}" target="_blank" class="link">${contact.data.github}</a></span>
    </div>
    <div class="table-row">
        <span class="table-key">ğŸ“ Location</span>
        <span class="table-value">${contact.data.location}</span>
    </div>
</div>

<div class="section-header">ğŸ’¼ I'm Looking For</div>
<div style="margin: 15px 0;">
${contact.data.lookingFor.map((item: { text: string; color: string }) => `<div class="list-item"><span class="text-${item.color}">${item.text}</span></div>`).join("\n")}
</div>

<p class="text-comment" style="margin-top: 20px;">
    <span class="text-green glow">â–¸</span> Let's build something awesome together! ğŸš€
</p>`;

// Build neofetch section HTML
const neofetchHtml = `
<div class="neofetch">
    <div class="neofetch-logo">
       â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„
      â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ
      â–ˆâ–‘â–‘â–ˆâ–€â–€â–ˆâ–‘â–ˆâ–€â–€â–‘â–‘â–‘â–‘â–‘â–ˆ
      â–ˆâ–‘â–‘â–ˆâ–„â–„â–ˆâ–‘â–€â–€â–ˆâ–‘â–‘â–‘â–‘â–‘â–ˆ
      â–ˆâ–‘â–‘â–ˆâ–‘â–‘â–‘â–‘â–„â–„â–ˆâ–‘â–‘â–‘â–‘â–‘â–ˆ
      â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ
      â–ˆâ–‘â–€â–ˆâ–€â–‘â–€â–ˆâ–€â–‘â–ˆâ–€â–ˆâ–‘â–‘â–‘â–ˆ
      â–ˆâ–‘â–‘â–ˆâ–‘â–‘â–‘â–ˆâ–‘â–‘â–ˆâ–„â–ˆâ–‘â–‘â–‘â–ˆ
      â–ˆâ–‘â–€â–€â–€â–‘â–€â–€â–€â–‘â–€â–‘â–€â–‘â–‘â–‘â–ˆ
      â–ˆâ–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–ˆ
    </div>
    <div class="neofetch-info">
        <div class="neofetch-title">priyanshu@portfolio</div>
        <div class="neofetch-separator">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>
${neofetch.data.rows.map((row: { label: string; value: string }) => `        <div class="neofetch-row">
            <span class="neofetch-label">${row.label}</span>
            <span class="neofetch-value">${row.value}</span>
        </div>`).join("\n")}
        <div class="color-blocks">
            <span class="color-block" style="background: var(--red)"></span>
            <span class="color-block" style="background: var(--orange)"></span>
            <span class="color-block" style="background: var(--yellow)"></span>
            <span class="color-block" style="background: var(--green)"></span>
            <span class="color-block" style="background: var(--cyan)"></span>
            <span class="color-block" style="background: var(--blue)"></span>
            <span class="color-block" style="background: var(--magenta)"></span>
            <span class="color-block" style="background: var(--purple)"></span>
        </div>
    </div>
</div>`;

// Create the commands data object to pass to Terminal
const commandsData = JSON.stringify({
  about: aboutHtml,
  skills: skillsHtml,
  experience: experienceHtml,
  projects: projectsHtml,
  achievements: achievementsHtml,
  education: educationHtml,
  contact: contactHtml,
  neofetch: neofetchHtml,
});
---

<Layout title="priyanshu@dev ~ portfolio">
  <Terminal commandsData={commandsData} />
</Layout>

